!function(){"use strict";var i="https://static.popmechanic.ru",n=document;function t(){var i=Boolean(window.MindboxEndpointSettings),n=Boolean(window.PopMechanic&&window.PopMechanic.isSlaTrackingOn);return i&&n}var e=function(){if(t()){var i=window.PopMechanic.tabVisibility;i.duration=0,i.lastVisibilityStart="visible"===document.visibilityState?Date.now():null,i.start=Date.now()}},o=function(){if(!t())return 0;if("hidden"===document.visibilityState)return window.PopMechanic.tabVisibility.duration;var i=Date.now()-window.PopMechanic.tabVisibility.lastVisibilityStart;return window.PopMechanic.tabVisibility.duration+i},r=function(){if(!t())return 0;var i=Date.now()-window.PopMechanic.tabVisibility.start-o();return i<5?0:i},a=window.navigator.userAgent.toLowerCase();function c(i){return-1!==a.indexOf(i)}var s=c("windows"),d=!s&&c("android"),u=d&&c("mobile"),h=!s&&c("iphone"),l=c("ipod"),p=s&&c("phone"),w=c("blackberry")||c("bb10")||c("rim"),m=w&&!c("tablet"),f=(c("(mobile;")||c("(tablet;"))&&c("; rv:"),v=f&&c("mobile"),P=c("meego"),b=u||h||l||p||m||v||P,g=c("ipad")||navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&/MacIntel/.test(navigator.platform),_=d&&!c("mobile"),M=w&&c("tablet"),I=s&&c("touch")&&!p,y=f&&c("tablet"),D=!b&&(g||_||M||I||y),E=!D&&!b;function S(){return b?"mobile":D?"tablet":E?"desktop":"unknown"}var x=parseInt("30000",10),U=function(i,n,t,e,a){if(void 0===t&&(t=[]),void 0===e&&(e=0),void 0===a&&(a=""),!window.PopMechanic.sampleSent){var c="failure",s=o(),d=s-e,u=r(),h=window.PopMechanic.tabVisibility&&window.PopMechanic.tabVisibility.startedInvisible,l=window.PopMechanic.tabVisibility&&window.PopMechanic.tabVisibility.lastVisibilityStart?window.PopMechanic.tabVisibility.lastVisibilityStart-window.PopMechanic.initAt:"never";"script-error"===i&&a&&(c="debug"),"timeout"===i&&s<.9*x&&(c="debug"),window.PopMechanic.sampleSent=!0;var p=window.PopMechanic.initReadyTs,w=window.PopMechanic.targetingReadyTs,m=navigator&&navigator.connection&&navigator.connection.downlink,f=S(),v=navigator&&navigator.webdriver;(new Image).src="https://personalization-speedtest-stable.mindbox.ru/check-reco?result="+c+(i?"&reason="+i:"")+"&t="+d+"&t1="+p+"&t2="+w+"&tl="+s+"&ti="+u+"&ts="+e+"&si="+(h?"1":"0")+"&lvs="+l+"&dl="+("number"==typeof m?m:"unknown")+"&dt="+f+"&wd="+(v?"1":"0")+"&c="+window.PopMechanic.client+"&url="+encodeURIComponent(location.pathname)+(n?"&fid="+n:"")+"&pfids="+t.join("-")+(a?"&se="+a:"")+"&_="+ +Date.now()}},T={},W=function(i,n,t,e,o){void 0===n&&(n=void 0),void 0===t&&(t=10),void 0===e&&(e=2e3),void 0===o&&(o=15);var r=null;if(void 0===n&&T[i])return T[i];var a=new Promise((function(a){var c=function(t,s){if(void 0!==window[i]&&(void 0===n||window[i]===n))return r=window[i],void a(r);s>=o?a(null):setTimeout((function(){var i=2*t;c(i>e?e:i,s+1)}),t)};c(t,0)}));return void 0===n&&(T[i]=a),a},A=function(i,n){void 0===i&&(i=[]),void 0===n&&(n=2e3);var t=new Promise((function(i){setTimeout(i,n)}));return Promise.race([Promise.all(i),t])},H=W("mindboxInitialized",!0),O=W("mindboxBatchedModulesInitialized",!0),V=function(){var i=W("mindbox",void 0,150,1e3,3);return A([i,H,O],1300)},R="https://personalization-web-stable.mindbox.ru",F=R+"/web/forms/",C=function(i){var n=i.method;void 0===n&&(n="GET");var t=i.url,e=i.options;return new Promise((function(i,o){var r=e&&e.withCredentials||!1,a=e&&e.retryLimit||3,c=function(){var e=new XMLHttpRequest;e.responseType="json",e.withCredentials=r,e.open(n,t,!0),e.send(),e.onload=function(){200===e.status&&i(e.response),o(e)},e.onerror=function(){if((0===e.status||e.status>=500)&&a>0)return a--,void c();o(e)}};c()}))},N=function(i){var n=function(i){return i.split(".").length>2?i.replace(/(^www\.)/gi,""):i}(i),t=n.split("."),e=[];e.push(n);for(var o=0;o<t.length-1;o++){var r="*"+t.slice(o,t.length).join(".");e.push(r)}return e},k=function(i){var n=Date.now(),t=new URLSearchParams(window.location.search),e=Math.floor("true"==t.get("mindbox_nocache")?n/1e3:n/3e5);return C(Object.assign({},i,{url:i.url+"?_="+e}))},q=function(i){return new Promise((function(n,t){if(!i.length)return t("promisesExecutors are empty");var e=[];i.forEach((function(i,n){return e.push(new L(i,(function(){return function(i){e.slice(i+1).forEach((function(i){return i.cancel()}))}(n)})))}));var o=e.map((function(i){return i.execute()}));return Promise.all(o).then((function(i){var e=i.findIndex((function(i){var n=i.error,t=i.cancelled;return!n&&!t}));if(e>-1)return n({data:i[e].data,index:e});var o=i[i.length-1];return t(o.error)}))}))},L=function(i,n){this._promiseExecutor=i,this._onResolve=n,this.cancel=this.cancel.bind(this),this.execute=this.execute.bind(this)};L.prototype._onResolve=function(){},L.prototype.cancel=function(){return Promise.resolve({cancelled:!0})},L.prototype.execute=function(){var i=this;return new Promise((function(n){i.cancel=function(){return n({cancelled:!0})},i._promiseExecutor().then((function(t){i._onResolve(),n({data:t})})).catch((function(i){return n({error:i})}))}))};var G=function(i){var n=i.s3Server,t=i.clientId,e=i.endpointId,o=i.hostname,r=i.s3Fetch;void 0===r&&(r=k);var a=i.accountHasPerDomainForms,c=i.runPrioritizedPromise;void 0===c&&(c=q),this._accountHasPerDomainForms=a,this._s3Server=n,this._clientId=t,this._endpointId=e?e.toLowerCase():void 0,this._hostname=o,this._runPrioritizedPromise=c,this._s3Fetch=r,this._getUrlWithDomainAndEndpoint=this._getUrlWithDomainAndEndpoint.bind(this),this._getUrlWithEndpoint=this._getUrlWithEndpoint.bind(this),this._getUrlWithDomain=this._getUrlWithDomain.bind(this),this._getApiUrlsWithEndpoint=this._getApiUrlsWithEndpoint.bind(this),this._getApiUrlsWithoutEndpoint=this._getApiUrlsWithoutEndpoint.bind(this),this._requestHead=this._requestHead.bind(this),this._requestGet=this._requestGet.bind(this)};G.prototype._getUrlWithDomainAndEndpoint=function(i){return this._s3Server+"/init/"+this._clientId+"/domain_and_endpoint/"+this._endpointId+":"+i},G.prototype._getUrlWithEndpoint=function(){return this._s3Server+"/init/"+this._clientId+"/endpoint/"+this._endpointId},G.prototype._getNoEndpointUrl=function(){return this._s3Server+"/init/"+this._clientId+"/no_endpoint"},G.prototype._getUrlWithDomain=function(i){return this._s3Server+"/init/"+this._clientId+"/domain/"+i},G.prototype._getNoDomainUrl=function(){return this._s3Server+"/init/"+this._clientId+"/no_domain"},G.prototype._getApiUrlsWithEndpoint=function(){var i=this,n=[];this._accountHasPerDomainForms&&N(this._hostname).forEach((function(t){var e=i._getUrlWithDomainAndEndpoint(t);n.push(e)}));return n.push(this._getUrlWithEndpoint()),{main:n,fallback:this._getNoEndpointUrl()}},G.prototype._getApiUrlsWithoutEndpoint=function(){var i=this,n=[];this._accountHasPerDomainForms&&N(this._hostname).forEach((function(t){var e=i._getUrlWithDomain(t);n.push(e)}));return{main:n,fallback:this._getNoDomainUrl()}},G.prototype._requestHead=function(i){return this._s3Fetch({url:i,method:"HEAD"})},G.prototype._requestGet=function(i){return this._s3Fetch({url:i,method:"GET"})},G.prototype.fetch=function(){var i=this,n=this._endpointId?this._getApiUrlsWithEndpoint():this._getApiUrlsWithoutEndpoint(),t=n.main.map((function(n){return function(){return i._requestHead(n)}}));return(1===n.main.length?this._requestGet(n.main[0]):this._runPrioritizedPromise(t).then((function(t){var e=t.index;return i._requestGet(n.main[e])}))).catch((function(){return i._requestGet(n.fallback)})).catch((function(){return null}))};var z=function(i){var n=i.endpointId,t=i.formHash,e=i.clientId,o=i.accountHasPerDomainForms;if(window.__POPMECHANIC_INIT)return Promise.resolve(window.__POPMECHANIC_INIT);if(t)return function(i){var n=i.endpointId,t=i.clientId,e=i.formHash;return C({method:"GET",url:F+e+"/?c="+t+"&domain="+encodeURIComponent(location.host)+(n?"&endpointId="+encodeURIComponent(n):""),options:{withCredentials:!0}})}({endpointId:n,formHash:t,clientId:e});if(window.__PRELOADED_PERSONALIZATION_CONFIG){var r=window.__PRELOADED_PERSONALIZATION_CONFIG;return delete window.__PRELOADED_PERSONALIZATION_CONFIG,Promise.resolve(r)}return new G({s3Server:"https://personalization-web-stable.mindbox.ru",clientId:e,endpointId:n,hostname:location.hostname,accountHasPerDomainForms:o}).fetch()},B=null,j=function(i){return void 0===i&&(i=!0),i&&B?Promise.resolve(B):V().then((function(){if(!window.mindbox)return{endpointId:null,deviceUUID:null};var i=new Promise((function(i){window.mindbox("helpers.getDeviceUUID",(function(n){i(n||null)}))})),n=new Promise((function(i){window.mindbox("helpers.getEndpointId",(function(n){i(n||null)}))}));return Promise.all([n,i]).then((function(i){return{endpointId:i[0],deviceUUID:i[1]}}))})).then((function(i){var n=i.endpointId,t=i.deviceUUID,e=void 0===window.PopMechanic.accountHasPerDomainForms||window.PopMechanic.accountHasPerDomainForms;return z({endpointId:n,clientId:window.PopMechanic.client,formHash:window.PopMechanic.formHash,accountHasPerDomainForms:e}).then((function(i){return{config:i,deviceUUID:t}})).catch((function(i){return i.status>=400&&U("init-error"),Promise.resolve({deviceUUID:t,config:null})})).then((function(i){return B=i}))}))},Z=function(){var i=window.PopMechanic.tabVisibility;if("visible"===document.visibilityState)return i.lastVisibilityStart=Date.now(),void window.PopMechanic.resumeWatchdog(i.duration);window.PopMechanic.pauseWatchdog(),i.lastVisibilityStart&&(i.duration+=Date.now()-i.lastVisibilityStart)};function J(){window.MindboxEndpointSettings&&window.PopMechanic&&window.PopMechanic.restartWatchdog&&!window.PopMechanic.isSlaTrackingOn&&(window.PopMechanic.isSlaTrackingOn=!0,window.PopMechanic.restartWatchdog(),window.PopMechanic.tabVisibility={duration:0,lastVisibilityStart:null,start:Date.now(),startedInvisible:"visible"!==document.visibilityState},Z(),document.addEventListener("visibilitychange",Z))}var X=parseInt("30000",10),K=[],Q=0;!function(){if(window.PopMechanicMutex)J();else{window.PopMechanicMutex=!0;var a=+Date.now(),c=function(i,t){void 0===t&&(t=n);var e=t.getElementById("popmechanic-script");if(!e)for(var o=i.replace(/^https?:\/\//,""),r=t.getElementsByTagName("script"),a=0;a<r.length;a++){var c=r[a];c.src.indexOf(o)>-1&&c.src.indexOf("?c=")>-1&&(e=c)}return e?e.src.split("?c=")[1].split("&")[0]:null}(i);if(c||window.PopMechanic){var s,d=-1!==(s=document.location.toString()).indexOf("pm-test-form=")?s.split("pm-test-form=")[1].split("&")[0]:"";window.PopMechanic=function(i){var n=i.formHash,t=i.clientId,a=i.loadedTs,c=i.initialPopMechanic||{loaded:!1,onLoad:!1,customs:{}};return c.client||(c.client=t),c.formHash=n,c.isTesting=!!n,c.dummyIsRequired=location.href.indexOf("pm-dummy")>-1,void 0===c.debugMode&&(c.debugMode="1"===sessionStorage["popmechanic-debug"]),c.loadedTimestamp=a,c.globalUtils={getIntegrationPromise:W,waitPromisesOrDelay:A,getMindboxIsReadyPromise:V,reportFailure:U,getSettings:j,getTabVisibilityDuration:o,getTabInvisibilityDuration:r,resetTabVisibilityDuration:e,getDeviceType:S},c}({formHash:d,clientId:c,loadedTs:a,initialPopMechanic:window.PopMechanic}),window.PopMechanic.initStartedAt=Date.now(),function(){window.PopMechanic.watchdogPaused=!1;var i=function(){window.PopMechanic.slaRequired&&(window.PopMechanic.sampleSent&&window.PopMechanic.loaded||U("timeout",void 0,K,Q))},n=function(n){void 0===n&&(n=0);var t=X-n+Q;return t>0?setTimeout(i,t):(i(),null)};window.PopMechanic.restartWatchdog=function(){t()&&(window.PopMechanic.slaRequired=!1,window.PopMechanic.sampleSent=!1,clearTimeout(window.PopMechanic.watchdog),window.PopMechanic.watchdog=n())},window.PopMechanic.pauseWatchdog=function(){t()&&!window.PopMechanic.watchdogPaused&&(clearTimeout(window.PopMechanic.watchdog),window.PopMechanic.watchdog=null)},window.PopMechanic.resumeWatchdog=function(i){t()&&!window.PopMechanic.watchdogPaused&&(window.PopMechanic.watchdog&&clearTimeout(window.PopMechanic.watchdog),window.PopMechanic.watchdog=n(i))},window.PopMechanic._saveWatchdogInfo=function(i,n){K=i,Q=n},window.PopMechanic._saveWatchdogFirstRecoSearchBlockTime=function(i){Q=i}}(),J(),j().then((function(n){var t=n.config;t&&t.forms.length&&function(i){var n=i.version,t=i.host;if(window.MindboxScripts&&window.MindboxScripts.executeFormsJs)window.MindboxScripts.executeFormsJs();else{var e=document.createElement("script");e.async="async",e.defer="defer",e.charset="utf-8",e.src=t+"/service/v2/forms.js?v="+n,document.head.appendChild(e)}if(window.MindboxScripts&&window.MindboxScripts.executeStylesCss)window.MindboxScripts.executeStylesCss();else{var o=document.createElement("link");o.rel="stylesheet",o.href=t+"/service/styles.css?v="+n,document.head.appendChild(o)}}({version:"4.48.30",host:i})}))}else console.error("Incorrect setup of Personalization tracker")}}()}();
